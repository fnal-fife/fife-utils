#!/usr/bin/env python

try:
    from six import *
except:
    pass

from samweb_client.exceptions import *
from samweb_client import *
from fife_sam_utils import *
import sys
import os
import grp
import optparse

def report_stage_status(ds, locality, tapes):
    print("   Staging status for: %s" %  ds.name)
    print("          Total Files: %d" % len(ds.flist))
    print("        Tapes spanned: %d" % len(tapes))
    print("Percent files on disk: %d%%" % (int(locality['ONLINE'] * 100 / len(ds.flist) )))
    

if __name__ == '__main__':

    log_startup()

    experiment = os.environ.get('EXPERIMENT',os.environ.get('SAM_EXPERIMENT',grp.getgrgid(os.getgid())[0]))
    
    parser = optparse.OptionParser(usage="usage: %prog [options] dataset [dataset ...] \n make sure files in dataset actually exist")
    parser.add_option('-v','--verbose',   action='count')
    parser.add_option('-j','--just_say',  action='store_true', help="do not actually copy, just say what you would do")
    parser.add_option('-p','--prune',  action='store_true', help="prune locations we cannot reach")
    parser.add_option('-e','--experiment', default=experiment, help='use this experiment server defaults to $SAM_EXPERIMENT if not set')
    parser.add_option('-n', '--name',     help="dataset name to validate", )
    parser.add_option('-f', '--file',     help="single file to validate", )
    parser.add_option('-l', '--locality', action='store_true', help='check DCache locations to see what is staged', default = False)
    parser.add_option('-L', '--listtapes', action='store_true', help='list what tapes SAM thinks files are on', default = False)
    parser.add_option('-T', '--tapeloc', action='store_true', help='check DCache locations to see what tapes things are on', default = False)
    parser.add_option('--location', help="only check matching locations", action='append', default=[])
    parser.add_option('--stage_status', help="generate staging status report", action='store_true', default = False)

    (o,a) = parser.parse_args()

    if o.verbose > 1:
        logging.basicConfig(level=logging.DEBUG)
    elif o.verbose > 0:
        logging.basicConfig(level=logging.INFO)
    else:
        logging.disable(logging.INFO)

    if o.experiment:
        os.environ['EXPERIMENT']= o.experiment
        os.environ['SAM_EXPERIMENT']= o.experiment
        os.environ['IFDH_BASE_URI'] = "http://samweb.fnal.gov:8480/sam/%s/api" % o.experiment
    else: 
        sys.stderr.write("Error: Need either --experiment or $EXPERIMENT $SAM_EXPERIMENT in environment")
        os.exit(1)

    cert = get_standard_certificate_path(o)
    os.environ['X509_USER_PROXY'] = cert

    if not o.name and not o.file:
        parser.error("expected --name dataset-name or --file filename")
        exit(1)

    if o.name:
        ds =dataset(o.name)

    if o.file:
        ds =fake_file_dataset(o.file)

    if o.stage_status:
        o.locality = {}
        o.locality['ONLINE'] = 0
        o.list_tapes = set()
        o.tapeloc = True

    if o.locality and not os.access("/pnfs/%s" % o.experiment, os.O_RDONLY):
        sys.stderr.write("Notice: cannot do locality checks here: /pnfs/%s not visible\n" % o.experiment)
        o.locality = False
        o.stage_status = False

    if o.tapeloc and not os.access("/pnfs/%s" % o.experiment, os.O_RDONLY):
        sys.stderr.write("Notice: cannot do tape label checks here: /pnfs/%s not visible\n" % o.experiment)
        o.tapeloc = False
        o.stage_status = False
    res = validate(ds , just_say = o.just_say, prune = o.prune, verbose = o.verbose , experiment = o.experiment, locality=o.locality, list_tapes=o.listtapes, tapeloc=o.tapeloc, location = o.location)

    if o.stage_status:
        report_stage_status(ds, o.locality, o.list_tapes)

    if 0 == res:
        log_finish("Success")
    else:
        log_finish("Fail")

    sys.exit(res)

  
