#!/usr/bin/env python

from samweb_client import *
from fife_sam_utils import *
import sys
import os
import optparse

def validate( ds, just_say = False, prune = False, verbose = False ):
    samweb = SAMWebClient()
    res=0

    for p in ds.fullpath_iterator():
        if just_say and not prune:
            print "I would: ifdh ls %s 0" % p
        else:
            if len(ds.ifdh_handle.ls(p,0,'')) == 0:
                print "missing: %s" % p
                res = 1
                if prune:
                    if just_say:
                       print "I would remove location: %s for %s " % (samprefix(p)+dirname(p), basename(p))
                    else:
                        samweb.removeFileLocation(basename(p),  samprefix(p) + dirname(p))
                        print "-- location removed"
            else:
                if verbose: print "located: %s" % p

    for f in ds.file_iterator():
        l = ds.ifdh_handle.locateFile(f)
        if len(l) == 0:
           print "file %s has 0 locations"
           res = 1

    return res


if __name__ == '__main__':
    
    parser = optparse.OptionParser(usage="usage: %prog [options] dataset [dataset ...] \n make sure files in dataset actually exist")
    parser.add_option('-v','--verbose',   action='count')
    parser.add_option('-j','--just_say',  action='store_false', help="do not actually copy, just say what you would do")
    parser.add_option('-p','--prune',  action='store_false', help="prune locations we cannot reach")
    parser.add_option('-e','--experiment')
    parser.add_option('-n', '--name',     help="dataset name to copy", )

    (o,a) = parser.parse_args()

    if o.experiment:
        os.environ['EXPERIMENT']= o.experiment
        os.environ['IFDH_BASE_URI'] = "http://samweb.fnal.gov:8480/sam/%s/api" % o.experiment

    if not o.name:
        parser.error("expected --name dataset-name")
        exit(1)

    res = validate(dataset(o.name), just_say = o.just_say, prune = o.prune, verbose = o.verbose)

    sys.exit(res)
