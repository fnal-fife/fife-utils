#!/usr/bin/env python

from fife_sam_utils import *
import hashlib 
import sys
import os
from samweb_client import *
import socket
import optparse



def modify_dataset_metadata( d, mdfilename,  just_say = False, verbose = False, experiment = None ):
    samweb = SAMWebClient()

    if experiment:
        samweb.experiment = experiment


    mdfile = mdfilename.open()
    for f in d.file_iterator():
        if just_say:
             print "I would modify metadata for %s with metadata file %s" % (f, mdfile)
        else:
            mdfile.seek(0,0)
            samweb.modifyFileMetadata(f, mdfile=mdfile)


if __name__ == '__main__':

    parser = optparse.OptionParser(usage="usage: %prog [options] \n modify metadata on all files in dataset")
    parser.add_option('-v','--verbose',   action='count')
    parser.add_option('-j','--just_say',  action='store_false', help="do not actually copy, just say what you would do")
    parser.add_option('-e','--experiment')
    parser.add_option('-n', '--name',     help="dataset name to modify", )
    parser.add_option('-m', '--metadata', help="metadata file with updates", )

    (o,a) = parser.parse_args()

    if o.experiment:
        os.environ['EXPERIMENT']= o.experiment
        os.environ['IFDH_BASE_URI'] = "http://samweb.fnal.gov:8480/sam/%s/api" % o.experiment

    if not o.name:
        parser.error("expected --name dataset-name")
        exit(1)

    if not o.metadata:
        parser.error("expected --dest url")
        exit(1)

    modify_dataset_metadata(dataset(o.name), o.metadata,  just_say = o.just_say,  verbose = o.verbose, experiment=o.experiment)
