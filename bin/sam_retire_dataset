#!/usr/bin/env python

from fife_sam_utils import *
from samweb_client import *
import hashlib 
import sys
import os
import re

def retire( d, just_say = False, keep_files = False, delete_match = '.*' ):
    samweb = SAMWebClient()

    for full in d.fullpath_iterator():
        file = basename(full)
	if just_say:
	    if not keep_files:
	        if re.match(delete_match, full): 
	            print "I would 'ifdh rm %s'" % full
	    print "I would remove location %s for %s" % ( file, samprefix(full)+dirname(full) )
	else:
	    if not keep_files:
		try:
                    if re.match(delete_match, full): 
		        d.ifdh_handle.rm(full, '')
		except:
		    pass
	    samweb.removeFileLocation(file, samprefix(full) + dirname(full))

    for file in d.file_iterator():
        if just_say:
            print "I would retire file: %s" %  file
        else:
            try:
                samweb.retireFile(file)
            except:
                print "Ouch! retriring %s" % file
                pass
    
    if just_say:
         print "I would deleteDefinition( %s ) " % ds.name
    else:
         samweb.deleteDefinition(d.name)


def usage(argv):
    print argv[0], ": usage: "
    print argv[0], " [options] dataset_name1  dataset_name2 ..."
    print "	-- retire files in dataset"
    print " options: "
    print "   -k     # keep files, do not delete them"
    print "   -m re  # delete files matching regular expression re"
    print "   -n     # don't actually do anything, say what would happen"
    print "   -h     # print help message" 

if __name__ == '__main__':
    
    just_say = False
    keep_files = False
    delete_match = ".*"

    cmd = sys.argv[0]

    while len(sys.argv) > 1 and sys.argv[1][0] == "-":

      if sys.argv[1] == "-k":
        keep_files = True
        sys.argv = sys.argv[1:]
        sys.argv[0] = cmd
        continue

      if sys.argv[1] == "-m":
        delete_match = sys.argv[2]
        sys.argv = sys.argv[2:]
        sys.argv[0] = cmd
        continue

      if sys.argv[1] == "-n":
        just_say = True
        sys.argv = sys.argv[1:]
        sys.argv[0] = cmd
        continue

      if sys.argv[1] == '-h':
        usage(sys.argv)
        exit(0)

      print "unknown option %s" % sys.argv[1]
      usage(sys.argv)
      exit(1)

    if len(sys.argv) == 1:
        usage(sys.argv)
        exit(1)

    for ds in sys.argv[1:]:
       retire(dataset(ds), just_say = just_say, keep_files = keep_files, delete_match = delete_match)

