#!/usr/bin/env python

from fife_sam_utils import dataset
import sys
import os
import optparse

def pin( ds , just_say = False, verbose = False ):
    thirtydays = 30 * 24 * 60 * 60
    for p in ds.fullpath_iterator():
        if p.startswith('/pnfs'):
            if just_say:
                print "I would ifdh pin ", p, " for ", thirtydays
            else:
                if verbose: print "pinning: ", p, " for ", thirtydays
                ds.ifdh_handle.pin( p, thirtydays )

if __name__ == '__main__':
    
    cmd = sys.argv[0]
    just_say = False

    parser = optparse.OptionParser(usage="usage: %prog [options] dataset dest_url \n pin in dataset in dcache for 30 days")
    parser.add_option('-v','--verbose',   action='count')
    parser.add_option('-n','--just_say',  action='store_false', help="do not actually copy, just say what you would do")
    parser.add_option('-e','--experiment')

    (o,a) = parser.parse_args()

    if o.experiment:
        os.environ['EXPERIMENT']= o.experiment
        os.environ['IFDH_BASE_URI'] = "http://samweb.fnal.gov:8480/sam/%s/api" % o.experiment

    if len(a) == 0:
        parser.error("expected at least one dataset parameter")
        exit(1)

    for ds in a:
       pin(dataset(ds), o.just_say, o.verbose)

