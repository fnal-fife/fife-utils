#!/usr/bin/env python

from fife_sam_utils import dataset
import sys
import os
import optparse

def pin( ds , just_say = False, verbose = False ):
    thirtydays = 30 * 24 * 60 * 60
    for p in ds.fullpath_iterator():
        if p.startswith('/pnfs'):
            if just_say:
                print "I would ifdh pin ", p, " for ", thirtydays
            else:
                if verbose: print "pinning: ", p, " for ", thirtydays
                ds.ifdh_handle.pin( p, thirtydays )

if __name__ == '__main__':
    
    cmd = sys.argv[0]
    just_say = False

    parser = optparse.OptionParser(usage="usage: %prog [options] \n pin in dataset in dcache for 30 days")
    parser.add_option('-v','--verbose',   action='count')
    parser.add_option('-j','--just_say',  action='store_true', help="do not actually pin, just say what you would do")
    parser.add_option('-e','--experiment')
    parser.add_option('-n', '--name',     help="dataset name to pin", )

    (o,a) = parser.parse_args()

    if o.experiment:
        os.environ['EXPERIMENT']= o.experiment
        os.environ['IFDH_BASE_URI'] = "http://samweb.fnal.gov:8480/sam/%s/api" % o.experiment

    if not o.name:
        parser.error("expected --name dataset-name")
        exit(1)

    pin(dataset(o.name), o.just_say, o.verbose)

